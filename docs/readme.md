==================================
# ТЕРМИНЫ
----------------------------------

### Тест

JavaScript файл, лежащий где - либо внутри пакета тестов.
Этот файл просто запускается движком тестов.
Что делается внутри файла - дело автора теста, никаких ограничений нет.

Тест, используя API движка, может (и это очень рекомендуется) писать лог о своих действиях
(см. Лог теста).

Имена config.js, и suiteConfig.js используются как конфиги, а не как тесты.

### Лог теста.

Текстовый файл, создаваемый движком и API вызовами из исходника теста (см. Тест).
В нем отражается сценарий выполнения теста, т.е. что происходит и с каким результатом.
В идеале, должен быть очень похож на соответствующую секцию тестплана.
В конце лога движок дописывает статистическую информацию по тесту и если включены соответствующие опции
конфига - добавляет логи от браузерной консоли.

Имя файла для лога теста такое же, как у теста, но расширение 'log', а не 'js'.

### Лог пакета.

Лог со статистической информацией по всем тестам пакета.
Называется так же, как директория пакета, но добавляется расширение '.log'.
Рассылается на мейл.

==================================
# ПРЕРЕКВИЗИТЫ
----------------------------------

* diff, rm, zip (на Windows можно установить Cygwin, на Linux есть родные)
* sencha
* nodejs (версия должна поддерживать --harmony опцию, т.к. тестовый движок использует ES6 стандарт)
* клон репозитория r-vision
* TODO: Причем, git pull нужно сделать r-vision/test утилитой gitpull.sh, она создаст лог git pull, который будет посылаться
  по почте.
* Xvfb (если нужно запускать тесты под Linux без GUI).
	Запускать так:
	 $ Xvfb :1 -screen 5 2560x1440x24
	Убивать можно так:
	 $ killall Xvfb

	На сервере 10.8.0.22 лежит скрипт /etc/init.d/xvfb.
	Можно и вручную запускать и останавливать его, как и другие демоны.

==================================
# УСТАНОВКА
----------------------------------

В директории "r-vision" сделайте:

$ npm install

В директории "r-vision/assets" сделайте:

$ sencha app build

В директории "r-vision/test" сделайте:

$ npm install

Эта команда, помимо прочих модулей, установит chromedriver по такому пути:
"rvision/test/node_modules/chromedriver/lib/chromedriver/chromedriver"

Этот chromedriver используется тестами, для взаимодействия c google chrome.
Он должен попасть в PATH, например, можно сделать soft link в ~/bin, а ~/bin поместить в PATH.

==================================
# НАСТРОЙКА, подготовка к запуску (см. также секцию "Конфигурационные файлы" ниже).
----------------------------------

Перед запуском приложения (node app.js) нужно установить переменную окружения NODE_ENV=autotest.
NOTE: На 10.8.0.22 нужно использовать autotest22.

TODO: В будущем переменными окружения можно будет задавать браузер для тестирования.

Также нужно установить переменную окружения PORT=1338 (по умолчанию тестовый движок использует этот порт, 
хотя это можно перегрузить в конфигах).

Запустить приложение:

$ node app.js

Запустить Xvfb, если нужно (см. выше "Пререквизиты").

==================================
# КОНФИГУРАЦИОННЫЕ ФАЙЛЫ:
----------------------------------

Конфиги приложения находятся в директории:

r-vision/test/config

В этих файлая есть комментарии по всем опциям конфигов.

Вот так выглядит локальный конфиг (названия опций должны быть точно такими же как в r-vision/test/lib/dirConfig.js):
Последнее выражение в скрипте должно быть объектом с перегружаемыми опциями конфига.

```
var config = {
  sectTitle: "Config testing",
};

config;
```

Конфиг testSuite.js делается так же:

```
var config = {
  mailList: "vasya@pupkin.ru",
};

config;
```

==================================
# ЗАПУСК
----------------------------------

Вот так можно посмотреть хелп по запуску.

$ node [--harmony] tia-run.js --help

==================================
# СОГЛАШЕНИЯ ОБ ИМЕНАХ ФАЙЛОВ ТЕСТОВ
----------------------------------

Тесты выполняются по-алфавиту, поэтому, рекомендуется придерживаться названий, типа 00_CheckingSomeStuff.js.

==================================
# КАК ОНО РАБОТАЕТ, ЧТО НА ВЫХОДЕ.
----------------------------------

### Как работает движок и какие создаются файлы.

tia-run.js в параметрах (помимо прочего) получает директорию с тестами.

Движок рекурсивно проходит указанную директорию.

Файлы config.js в директориях запускаются, и используются для перегрузки конфигов (см. "Конфигурационные файлы").

Другие файлы `*.js` запускаются движком, в них должны находиться тесты, выполняющие что угодно (все, что может делать node.js),
и пишущие логи (`*.log`) (см. Лог Теста), используя API (см. apiHighLevel, apiLowLevel директории).

Для каждого теста есть эталонный лог (`*.et`), этот лог создается и тщательно проверяется автором теста.

После прогона теста, его текущий лог сравнивается с эталонным. Если есть разница, она записывается в виде `*.dif` файла.

Есть возможность создавать эталонные дифы (`*.edif`). Если диф равен эталонному, то он в логе пакета не считается дифом.

### При ошибках в лог теста пишутся:
 * информация об ошибке
 * консоль браузера
 * эксепшны, возникшие в браузере
 * путь к скриншоту, сделанному после обнаружения ошибки (это `*.png` файл.)

### Помимо локальных файлов для каждого теста, создаются общие логи статистики по всем тестам.

Эти логи рассылаются на почту.
Также на почту отсылается архив с результатами тестов, если соответвующие опции включены в конфиге.

#### В заголовке письма используются следующие обозначения:

linux_3.16.0-4-amd64, AS PREV , "testsWdHelpers", Dif: 0, Fail: 0, EDif: 0, Skip: 0, Pass: 4, 19203.05 ms

* linux_3.16.0-4 - Операционная система.
* amd64 - Платформа.
* Один из трех вариантов, показывающий отношение текущего прогона к предыдущему:
	* CHANGED - означает, что появились дифы в тестах, где дифов не было, или исчезли дифы для тестов, где дифы были.
	* AS PREV - означает, что при текущем прогоне абсолютно такие же результаты, что и при предыдущем.
	* AS PREV (8 diff(s) changed). - дифы в тех же тестах, что и раньше, но какие-то дифы изменились.
* testsWdHelpers - имя корневой директории для тестов.
* Dif: 0, - ноль тестов имеют неожиданные дифы.
* Fail: 0, - ноль ошибок во всех тестах.
* EDif: 0, - ноль ожидаемых дифов.
* Skip: 0, - ноль тестов проигнорено (из-за skip: true в локальном конфиге)
* Pass: 4, - 4 команды во всех тестах сообщили о том, что они прошли успешно.
* 19203.05 ms - тесты шли 19 с копейками секунд.


#### В логах используются следующие обозначения:

Обозначения те же, что и выше, только теперь они расписаны для каждой директории и каждого теста.
Лог состоит из двух частей: короткой (содержащей только подифанные тесты), и длинной (содержащей все тесты).

### Статус возврата, stdout, stderr.

tia-run.js возвращает 0 если тесты прошли ожидаемо и 1, если есть неожиданные дифы.

Конфиг опция logToStdErrOut со значением true, приводит к выводу лога в stderr и stdout, см. описание этой опции в r-vision/test/config/dirConfig.js.

==================================
# API ДЛЯ СОЗДАНИЯ ТЕСТОВ:
----------------------------------

В директориях apiHighLevel, apiLowLevel находятся функции, которые выполняют эмуляцию действий пользователя, логирование, и другие действия.
См. документацию в комментариях к функциям.

==================================
# FAQ:
----------------------------------

* Как запускать тесты на Windows, чтобы они не мешали работать?

  Можно установить desktops и запускать тесты на альтернативном рабочем столе.
  https://technet.microsoft.com/en-us/library/cc817881.aspx

	TODO: давно не тестировал на Windows, не уверен, что сходу всё заработает.

==================================
# Содержимое директории r-vision/test:
----------------------------------
* r-vision/assets/resources/js/TestHelper.js - клиентский скрипт для поддержки не ExtJS части.
* r-vision/assets/resources/js/TestHelperExt.js - клиентский скрипт для поддержки ExtJS части.
* r-vision/test:
* apiHighLevel - высокоуровневые функции для использования в тестах, например, логин.
* apiLowLevel - низкоуровневые функции для использования в тестах, например, кликнуть мышью туда-то.
* bamboo.js - скрипт для запуска с помощью bamboo. Сам запускает приложение, тестирует, останавливает приложение.
              (обертка над tia-run.js)
* docs - документация.
*     readme.md - этот файл.
*     Suggestions.txt - предложения по усовершенствованию движка.
*     TODO.txt - TODO лист для автора тестов.
* engine - движок тестов.
* logViewer - здесь разрабатывается веб-клиент для очень удобного изучения логов.
* testSuites - директория с пакетами тестов.
*     app - Примеры тестов для приложения.
*     engine - Тесты для движка тестирования.
*     wdHelpers - Тесты для low level and high level API функций.
*     *.log - логи от тестов.
*     *.log.json - логи в JSON формате (для последующего использования веб - просмотрщиком логов)
*     *.log.notime - логи, с вырезанным временем.
*     *.log.notime.prev - предыдущие логи с вырезанным временем.
* utils - утилитные функции, используемые движком.
* tia-run.js - утилита для запуска тестов, наберите "node --harmony tia-run.js --help", для просмотра помощи по утилите.

==================================
# ИЗВЕСТНЫЕ ФИЧИ И БАГИ:
----------------------------------

Парочка тестов в пакете engine намеренно пишет несколько строк в stderr.
Эти строки могут подсвечиваться красным в bamboo.
